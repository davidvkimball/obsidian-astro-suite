/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var ue=Object.defineProperty;var Je=Object.getOwnPropertyDescriptor;var Ze=Object.getOwnPropertyNames;var Xe=Object.prototype.hasOwnProperty;var Ye=(a,i)=>()=>(a&&(i=a(a=0)),i);var Te=(a,i)=>{for(var e in i)ue(a,e,{get:i[e],enumerable:!0})},et=(a,i,e,s)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of Ze(i))!Xe.call(a,t)&&t!==e&&ue(a,t,{get:()=>i[t],enumerable:!(s=Je(i,t))||s.enumerable});return a};var Ce=a=>et(ue({},"__esModule",{value:!0}),a);var Ae={};Te(Ae,{getCMSViewOptions:()=>nt,readCMSSettings:()=>D});function D(a,i){var e,s,t,o,n,r,c,l,p,u,d,h,g,y,k,E;return{titleProperty:a.get("titleProperty")||"",descriptionProperty:a.get("descriptionProperty")||"",imageProperty:a.get("imageProperty")||"",showTitle:(e=a.get("showTitle"))!=null?e:!0,showDate:(s=a.get("showDate"))!=null?s:!1,dateProperty:a.get("dateProperty")||"",showTextPreview:(t=a.get("showTextPreview"))!=null?t:!0,fallbackToContent:(o=a.get("fallbackToContent"))!=null?o:!0,fallbackToEmbeds:(n=a.get("fallbackToEmbeds"))!=null?n:!1,propertyDisplay1:a.get("propertyDisplay1")||"",propertyDisplay2:a.get("propertyDisplay2")||"",propertyDisplay3:a.get("propertyDisplay3")||"",propertyDisplay4:a.get("propertyDisplay4")||"",propertyLayout12SideBySide:(r=a.get("propertyLayout12SideBySide"))!=null?r:!1,propertyLayout34SideBySide:(c=a.get("propertyLayout34SideBySide"))!=null?c:!1,imageFormat:a.get("imageFormat")||"thumbnail",propertyLabels:a.get("propertyLabels")||"hide",showDraftStatus:(l=a.get("showDraftStatus"))!=null?l:!1,draftStatusProperty:a.get("draftStatusProperty")||"",draftStatusReverse:(p=a.get("draftStatusReverse"))!=null?p:!1,draftStatusUseFilenamePrefix:(u=a.get("draftStatusUseFilenamePrefix"))!=null?u:!1,showTags:(d=a.get("showTags"))!=null?d:!1,tagsProperty:a.get("tagsProperty")||"",maxTagsToShow:(h=a.get("maxTagsToShow"))!=null?h:3,customizeNewButton:(g=a.get("customizeNewButton"))!=null?g:!1,newNoteLocation:a.get("newNoteLocation")||"",hideQuickEditIcon:(y=a.get("hideQuickEditIcon"))!=null?y:!1,cardSize:(k=a.get("cardSize"))!=null?k:250,imageAspectRatio:(E=a.get("imageAspectRatio"))!=null?E:.55}}function nt(){return[{type:"slider",displayName:"Card size",key:"cardSize",min:50,max:800,step:10,default:250},{type:"dropdown",displayName:"Card image",key:"imageFormat",options:{none:"No image",thumbnail:"Thumbnail",cover:"Cover"},default:"thumbnail"},{type:"slider",displayName:"Image aspect ratio",key:"imageAspectRatio",min:.1,max:2,step:.05,default:.55,showWhen:{key:"imageFormat",value:"cover"}},{type:"property",displayName:"Image property",key:"imageProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Use in-note images if image property unavailable",key:"fallbackToEmbeds",default:!1},{type:"toggle",displayName:"Show title",key:"showTitle",default:!0},{type:"property",displayName:"Title property",key:"titleProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show date",key:"showDate",default:!1},{type:"property",displayName:"Date property",key:"dateProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show draft status",key:"showDraftStatus",default:!1},{type:"property",displayName:"Draft status property",key:"draftStatusProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Reverse logic",key:"draftStatusReverse",default:!1},{type:"toggle",displayName:"Filename underscore prefix as draft indicator",key:"draftStatusUseFilenamePrefix",default:!1},{type:"toggle",displayName:"Show text preview",key:"showTextPreview",default:!0},{type:"property",displayName:"Text preview property",key:"descriptionProperty",placeholder:"Select property",default:""},{type:"toggle",displayName:"Use note content if text preview property unavailable",key:"fallbackToContent",default:!0},{type:"toggle",displayName:"Show tags",key:"showTags",default:!1},{type:"property",displayName:"Tags property",key:"tagsProperty",placeholder:"Select property",default:""},{type:"slider",displayName:"Maximum tags to show",key:"maxTagsToShow",min:1,max:50,step:1,default:3,showWhen:{key:"showTags",value:!0}},{type:"property",displayName:"First property",key:"propertyDisplay1",placeholder:"Select property",default:""},{type:"property",displayName:"Second property",key:"propertyDisplay2",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show first and second properties side by side",key:"propertyLayout12SideBySide",default:!1},{type:"property",displayName:"Third property",key:"propertyDisplay3",placeholder:"Select property",default:""},{type:"property",displayName:"Fourth property",key:"propertyDisplay4",placeholder:"Select property",default:""},{type:"toggle",displayName:"Show third and fourth properties side by side",key:"propertyLayout34SideBySide",default:!1},{type:"dropdown",displayName:"Show property labels",key:"propertyLabels",options:{hide:"Hide",inline:"Inline",above:"On top"},default:"hide"},{type:"toggle",displayName:"Customize new button behavior",key:"customizeNewButton",default:!1},{type:"text",displayName:"Default location for new notes",key:"newNoteLocation",placeholder:"Simply use / for vault folder",default:""},{type:"toggle",displayName:"Hide quick edit icon",key:"hideQuickEditIcon",default:!1}]}var z=Ye(()=>{"use strict"});var Et={};Te(Et,{default:()=>de});module.exports=Ce(Et);var Ge=require("obsidian");var x=require("obsidian");var ke=require("obsidian"),W=class extends ke.FuzzySuggestModal{constructor(e,s){super(e);this.onSelect=s}getItems(){let e=this.app.commands,s=new Map;if(e&&typeof e.listCommands=="function")try{let o=e.listCommands();for(let n of o)n&&n.id&&n.name&&!s.has(n.id)&&s.set(n.id,{id:n.id,name:n.name})}catch(o){console.warn("[Bases CMS] Error getting commands via listCommands():",o)}try{let o=e==null?void 0:e.commands;if(o&&typeof o=="object"){let n=Object.values(o);for(let r of n)r&&r.id&&r.name&&!s.has(r.id)&&s.set(r.id,{id:r.id,name:r.name})}}catch(o){console.warn("[Bases CMS] Error getting commands via registry:",o)}try{let o=e==null?void 0:e.commandRegistry;if(o&&typeof o=="object"){let n=Object.values(o);for(let r of n)r&&r.id&&r.name&&!s.has(r.id)&&s.set(r.id,{id:r.id,name:r.name})}}catch(o){console.warn("[Bases CMS] Error getting commands via internal registry:",o)}let t=Array.from(s.values());return t.sort((o,n)=>o.name.localeCompare(n.name)),t}getItemText(e){return e.name}onChooseItem(e,s){this.onSelect(e.id)}renderSuggestion(e,s){let t=e.item;s.createDiv({cls:"suggestion-title",text:t.name})}};var B=require("obsidian"),tt=()=>{if(B.requireApiVersion&&(0,B.requireApiVersion)("1.7.3")&&B.getIconIds)try{return(0,B.getIconIds)()}catch(a){console.warn("[Bases CMS] Error getting icon IDs from Obsidian:",a)}return["settings-2","settings","help-circle","info","star","heart","bookmark","home","search","bell","mail","user","users","folder","file","file-text","image","video","music","calendar","clock","edit","pencil","trash","copy","cut","paste","download","upload","save","share","link","external-link","lock","unlock","eye","eye-off","key","shield","check","x","plus","minus","arrow-left","arrow-right","arrow-up","arrow-down","chevron-left","chevron-right","chevron-up","chevron-down","menu","more-horizontal","more-vertical","grid","list","layout","columns","rows","maximize","minimize","zoom-in","zoom-out","refresh-cw","play","pause","stop","sun","moon","cloud","zap","wand-2","wand","wand-sparkles","palette","brush","sliders","power","wifi","bluetooth","monitor","laptop","smartphone","camera","mic","headphones","code","terminal","terminal-square","github","gitlab","git-branch","git-commit","database","server","cloud-download","cloud-upload","tag","tags","flag","pin","map-pin","compass","globe","rocket","car","bike","robot","apple","windows","linux","chrome","firefox","safari","credit-card","wallet","coins","book","book-open","award","trophy","badge","wrench","tool","package","box","archive","send","reply","forward","mail-open","tag-plus","tag-minus","flag-off","pin-off","map-pin-off","navigation","map","earth","plane","ship","anchor","helicopter","drone","android","keyhole","keys","fingerprint","scan","qr-code","barcode","receipt","piggy-bank","banknote","pencil-line","edit-2","edit-3"]},st=tt().map(a=>({id:a,name:a.replace(/^lucide-/,"").replace(/-/g," ").replace(/(^\w{1})|(\s+\w{1})/g,i=>i.toUpperCase())})).sort((a,i)=>a.name.localeCompare(i.name)),j=class extends B.FuzzySuggestModal{constructor(e,s){super(e);this.onSelect=s}getItems(){return st}getItemText(e){return e.name}onChooseItem(e,s){this.onSelect(e.id)}renderSuggestion(e,s){let t=e.item;s.addClass("mod-complex"),s.createDiv({cls:"suggestion-content"}).createDiv({cls:"suggestion-title",text:t.name});let n=s.createDiv({cls:"suggestion-aux"});(0,B.setIcon)(n.createSpan({cls:"suggestion-flair"}),t.id)}};var Q=class extends x.PluginSettingTab{constructor(e,s){super(e,s);this.plugin=s}refreshActiveToolbars(){let e=this.plugin;e&&typeof e.refreshAllToolbars=="function"&&e.refreshAllToolbars()}display(){let{containerEl:e}=this;e.empty(),new x.Setting(e).setName("Confirm bulk operations").setDesc("Show confirmation dialogs before performing bulk operations.").addToggle(n=>n.setValue(this.plugin.settings.confirmBulkOperations).onChange(r=>{(async()=>(this.plugin.settings.confirmBulkOperations=r,await this.plugin.saveData(this.plugin.settings)))()})),new x.Setting(e).setName("Toolbar buttons").setHeading(),new x.Setting(e).setName("Show select all button").setDesc("Display the select all button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarSelectAll).onChange(r=>{(async()=>(this.plugin.settings.showToolbarSelectAll=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Show clear button").setDesc("Display the clear selection button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarClear).onChange(r=>{(async()=>(this.plugin.settings.showToolbarClear=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Show publish button").setDesc("Display the publish button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarPublish).onChange(r=>{(async()=>(this.plugin.settings.showToolbarPublish=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Show draft button").setDesc("Display the draft button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarDraft).onChange(r=>{(async()=>(this.plugin.settings.showToolbarDraft=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Show tags button").setDesc("Display the tags button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarTags).onChange(r=>{(async()=>(this.plugin.settings.showToolbarTags=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Show set button").setDesc("Display the set property button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarSet).onChange(r=>{(async()=>(this.plugin.settings.showToolbarSet=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Show remove button").setDesc("Display the remove property button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarRemove).onChange(r=>{(async()=>(this.plugin.settings.showToolbarRemove=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Show delete button").setDesc("Display the delete button in the CMS toolbar.").addToggle(n=>n.setValue(this.plugin.settings.showToolbarDelete).onChange(r=>{(async()=>(this.plugin.settings.showToolbarDelete=r,await this.plugin.saveData(this.plugin.settings),this.refreshActiveToolbars()))()})),new x.Setting(e).setName("Deletions").setHeading(),new x.Setting(e).setName("Delete parent folder for specific file name").setDesc("When enabled, deleting a note will delete its parent folder and all its contents if the note file name matches the specified name.").addToggle(n=>n.setValue(this.plugin.settings.deleteParentFolder).onChange(r=>{(async()=>(this.plugin.settings.deleteParentFolder=r,await this.plugin.saveData(this.plugin.settings)))()})),new x.Setting(e).setName("Folder deletion file name").setDesc("File name that triggers parent folder deletion.").addText(n=>n.setPlaceholder("index").setValue(this.plugin.settings.deleteParentFolderFilename).onChange(r=>{(async()=>(this.plugin.settings.deleteParentFolderFilename=r,await this.plugin.saveData(this.plugin.settings)))()})).setDisabled(!this.plugin.settings.deleteParentFolder),new x.Setting(e).setName("Delete associated unique attachments").setDesc("When deleting a note, automatically delete attachments that are only used by that note. Attachments used by other notes will be preserved.").addToggle(n=>n.setValue(this.plugin.settings.deleteUniqueAttachments).onChange(r=>{(async()=>(this.plugin.settings.deleteUniqueAttachments=r,await this.plugin.saveData(this.plugin.settings)))()})),new x.Setting(e).setName("Confirm deletions").setDesc("Show confirmation dialog before deleting files.").addToggle(n=>n.setValue(this.plugin.settings.confirmDeletions).onChange(r=>{(async()=>(this.plugin.settings.confirmDeletions=r,await this.plugin.saveData(this.plugin.settings)))()})),new x.Setting(e).setName("Appearance").setHeading(),new x.Setting(e).setName("Use home icon for CMS view").setDesc("Use the home icon instead of blocks icon for the CMS view in the Bases view selector. Restart Obsidian for this change to take effect.").addToggle(n=>n.setValue(this.plugin.settings.useHomeIcon).onChange(r=>{(async()=>(this.plugin.settings.useHomeIcon=r,await this.plugin.saveData(this.plugin.settings)))()})),new x.Setting(e).setName("Quick edit").setHeading();let s,t,o;new x.Setting(e).setName("Enable quick edit").setDesc("Show an icon on card titles that launches a command when clicked.").addToggle(n=>n.setValue(this.plugin.settings.enableQuickEdit).onChange(r=>{(async()=>(this.plugin.settings.enableQuickEdit=r,await this.plugin.saveData(this.plugin.settings),s&&s.settingEl.toggleClass("bases-cms-setting-hidden",!r),t&&t.settingEl.toggleClass("bases-cms-setting-hidden",!r),o&&o.settingEl.toggleClass("bases-cms-setting-hidden",!r)))()})),s=new x.Setting(e).setName("Quick edit command").setDesc("The command to execute when clicking the quick edit icon on a card title.").addButton(n=>{var c;let r=this.plugin.settings.quickEditCommandName||(this.plugin.settings.quickEditCommand?"Select command...":"No command selected");if(n.setButtonText(r).onClick(()=>{new W(this.app,p=>{(async()=>{let u=this.app.commands,d="";if(u){if(typeof u.listCommands=="function"){let g=u.listCommands().find(y=>y.id===p);g&&(d=g.name)}if(!d){let h=u.commands;h&&h[p]&&(d=h[p].name||"")}}this.plugin.settings.quickEditCommand=p,this.plugin.settings.quickEditCommandName=d,await this.plugin.saveData(this.plugin.settings),this.display()})()}).open()}),this.plugin.settings.quickEditCommand){let l=(c=n.buttonEl.parentElement)==null?void 0:c.createEl("button",{text:"Clear",attr:{style:"margin-left: 8px;"}});l==null||l.addEventListener("click",()=>{(async()=>(this.plugin.settings.quickEditCommand="",this.plugin.settings.quickEditCommandName="",await this.plugin.saveData(this.plugin.settings),this.display()))()})}}),s.settingEl.toggleClass("bases-cms-setting-hidden",!this.plugin.settings.enableQuickEdit),t=new x.Setting(e).setName("Quick edit icon").setDesc("Select the icon to display for the quick edit button on card titles.").addButton(n=>{let r=this.getIconName(this.plugin.settings.quickEditIcon||"pencil-line");n.setButtonText(r||"Select icon...").onClick(()=>{new j(this.app,async l=>{this.plugin.settings.quickEditIcon=l,await this.plugin.saveData(this.plugin.settings),this.display()}).open()})}),t.settingEl.toggleClass("bases-cms-setting-hidden",!this.plugin.settings.enableQuickEdit),o=new x.Setting(e).setName("Attempt to open file and execute quick edit command").setDesc("For commands that don't have special handling, attempt to open the file and execute the command. Some commands may not work properly this way.").addToggle(n=>n.setValue(this.plugin.settings.quickEditOpenFile).onChange(r=>{(async()=>(this.plugin.settings.quickEditOpenFile=r,await this.plugin.saveData(this.plugin.settings)))()})),o.settingEl.toggleClass("bases-cms-setting-hidden",!this.plugin.settings.enableQuickEdit)}getIconName(e){return e?e.replace(/^lucide-/,"").split("-").map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "):""}};var Pe={confirmBulkOperations:!0,deleteParentFolder:!1,deleteParentFolderFilename:"index",deleteUniqueAttachments:!1,confirmDeletions:!0,useHomeIcon:!1,enableQuickEdit:!1,quickEditCommand:"",quickEditCommandName:"",quickEditIcon:"pencil-line",quickEditOpenFile:!1,showToolbarSelectAll:!0,showToolbarClear:!0,showToolbarDraft:!0,showToolbarPublish:!0,showToolbarTags:!0,showToolbarSet:!0,showToolbarRemove:!0,showToolbarDelete:!0};var U=require("obsidian");function L(a,i){if(!i||!i.trim())return null;let e=i.split(",").map(s=>s.trim()).filter(s=>s);for(let s of e){let t=a.getValue(s),o=t;if(o&&("date"in o&&o.date instanceof Date||"data"in o))return t}return null}function xe(a,i){if(!i||!i.trim())return[];let e=i.split(",")[0].trim();if(!e)return[];let s=a.getValue(e);if(!s||!("data"in s))return[];let t=s.data,o=[];if(Array.isArray(t)){for(let n of t)if(typeof n=="string"||typeof n=="number"){let r=String(n);if(r&&r.trim()){o.push(r);break}}}else if(t!=null&&t!==""&&(typeof t=="string"||typeof t=="number")){let n=String(t);n.trim()&&o.push(n)}return o}function De(a,i,e,s){if(!a||a==="")return"";if(e){let t=e;if(typeof t.getDisplayName=="function")try{let o=t.getDisplayName(a);if(o&&typeof o=="string"&&o.trim()!=="")return o}catch(o){}}return a}function it(a,i,e,s,t,o,n){let r=a.file.basename||a.file.name,c=L(a,i.titleProperty),l=c==null?void 0:c.data,p=l!=null&&l!==""&&(typeof l=="string"||typeof l=="number")?String(l):r,u=a.file.path,d=u.split("/").slice(0,-1).join("/"),h=a.getValue("note.tags"),g=[];if(h&&h.data!=null){let S=h.data;g=(Array.isArray(S)?S.map(b=>b&&typeof b=="object"&&"data"in b?String(b.data):typeof b=="string"||typeof b=="number"?String(b):"").filter(b=>b):typeof S=="string"||typeof S=="number"?[String(S)]:[]).map(b=>b.replace(/^#/,""))}let y=a.getValue("file.tags"),k=[];if(y&&y.data!=null){let S=y.data;k=(Array.isArray(S)?S.map(b=>b&&typeof b=="object"&&b!==null&&"data"in b?String(b.data):typeof b=="string"||typeof b=="number"?String(b):"").filter(b=>typeof b=="string"&&b.length>0):typeof S=="string"||typeof S=="number"?[String(S)]:[]).map(b=>b.replace(/^#/,""))}let E=a.file.stat.ctime,v=a.file.stat.mtime,m=[];if(i.showTags&&i.tagsProperty){let S=L(a,i.tagsProperty);if(S&&S.data!=null){let P=S.data;Array.isArray(P)?m=P.map(b=>b&&typeof b=="object"&&"data"in b?String(b.data):typeof b=="string"||typeof b=="number"?String(b):"").filter(b=>typeof b=="string"&&b.length>0):(typeof P=="string"||typeof P=="number")&&(m=[String(P)])}}let w={path:u,name:r,title:p,tags:k,yamlTags:g,ctime:E,mtime:v,folderPath:d,snippet:t,imageUrl:o,hasImageAvailable:n||!1,displayTags:m.length>0?m:void 0},f=[i.propertyDisplay1,i.propertyDisplay2,i.propertyDisplay3,i.propertyDisplay4],T=new Set,C=f.map(S=>!S||S===""||T.has(S)?"":(T.add(S),S));return w.propertyName1=C[0]||void 0,w.propertyName2=C[1]||void 0,w.propertyName3=C[2]||void 0,w.propertyName4=C[3]||void 0,w.property1=C[0]?_(C[0],a,w,i):null,w.property2=C[1]?_(C[1],a,w,i):null,w.property3=C[2]?_(C[2],a,w,i):null,w.property4=C[3]?_(C[3],a,w,i):null,w}function Fe(a,i,e,s,t,o,n){return a.map(r=>it(r,i,e,s,t[r.file.path],o[r.file.path],n[r.file.path]))}function _(a,i,e,s){if(!a||a==="")return null;if(a==="file.path"||a==="file path")return e.folderPath||null;if(a==="tags"||a==="note.tags")return e.yamlTags.length>0?"tags":null;if(a==="file.tags"||a==="file tags")return e.tags.length>0?"tags":null;if(a==="file.ctime"||a==="created time")return new Date(e.ctime).toLocaleDateString();if(a==="file.mtime"||a==="modified time")return new Date(e.mtime).toLocaleDateString();let t=L(i,a);if(!t)return null;let o=t;if(!o)return null;if("date"in o&&o.date instanceof Date)return o.date.toLocaleDateString();let n=o.data;return n==null||n===""?null:Array.isArray(n)?n.length===0?null:n.map(r=>r&&typeof r=="object"&&"data"in r?String(r.data):String(r)).filter(r=>r&&r.trim()!=="").join(", "):typeof n=="string"||typeof n=="number"||typeof n=="boolean"?String(n):null}z();function Me(a){return/^https?:\/\//i.test(a)}function ge(a){return/\.(avif|bmp|gif|jpe?g|png|svg|webp)$/i.test(a)}function Be(a){return new Promise(i=>{let e=new Image;e.onload=()=>i(!0),e.onerror=()=>i(!1),setTimeout(()=>i(!1),5e3),e.src=a})}function at(a){let i=a.match(/^!?\[\[([^\]|]+)(?:\|[^\]]*)?\]\]$/);return i?i[1].trim():a}async function Le(a){let i=[],e=[];for(let n of a){let r=at(n);r.length!==0&&(Me(r)?(ge(r)||!r.includes("."))&&e.push(r):ge(r)&&i.push(r))}let s=e.map(n=>Be(n).then(r=>r?n:null)),o=(await Promise.all(s)).filter(n=>n!==null);return{internalPaths:i,externalUrls:o}}function Ie(a,i,e){let s=["avif","bmp","gif","jpeg","jpg","png","svg","webp"],t=[];for(let o of a){let n=e.metadataCache.getFirstLinkpathDest(o,i);if(n&&s.includes(n.extension)){let r=e.vault.getResourcePath(n);t.push(r)}}return t}async function me(a,i){let e=["avif","bmp","gif","jpeg","jpg","png","svg","webp"],s=i.metadataCache.getFileCache(a);if(!(s!=null&&s.embeds))return[];let t=[],o=[];for(let l of s.embeds){let p=l.link;if(Me(p))(ge(p)||!p.includes("."))&&o.push(p);else{let u=i.metadataCache.getFirstLinkpathDest(p,a.path);if(u&&e.includes(u.extension)){let d=i.vault.getResourcePath(u);t.push(d)}}}let n=o.map(l=>Be(l).then(p=>p?l:null)),c=(await Promise.all(n)).filter(l=>l!==null);return[...t,...c]}var ot=[/`([^`]+)`/g,/\*\*\*((?:(?!\*\*\*).)+)\*\*\*/g,/___((?:(?!___).)+)___/g,/\*\*((?:(?!\*\*).)+)\*\*/g,/__((?:(?!__).)+)__/g,/\*((?:(?!\*).)+)\*/g,/_((?:(?!_).)+)_/g,/~~((?:(?!~~).)+)~~/g,/==((?:(?!==).)+)==/g,/\[([^\]]+)\]\([^)]+\)/g,/!\[\[[^\]]+\]\]/g,/\[\[[^\]|]+\|[^\]]+\]\]/g,/\[\[[^\]]+\]\]/g,/#[a-zA-Z0-9_\-/]+/g,/^[-*+]\s*\[[ xX]\]\s+/gm,/^(\d+\.\s*)\[[ xX]\]\s+/gm,/^(\d+\)\s*)\[[ xX]\]\s+/gm,/^[-*+]\s+/gm,/^#{1,6}\s+.+$/gm,/^\s*(?:[-_*])\s*(?:[-_*])\s*(?:[-_*])[\s\-_*]*$/gm,/^\s*\|.*\|.*$/gm,/\^\[[^\]]*?]/g,/\[\^[^\]]+]/g,/^\s*\[\^[^\]]+]:.*$/gm,/<([a-z][a-z0-9]*)\b[^>]*>(.*?)<\/\1>/gi,/<[^>]+>/g];function rt(a){let i=new Map,e=0;return{text:a.replace(/\\(.)/g,(t,o)=>{let n=`\xA7\xA7ESCAPED${e}\xA7\xA7`;return i.set(n,o),e++,n}),map:i}}function lt(a,i){let e=a;return i.forEach((s,t)=>{e=e.split(t).join(s)}),e}function ct(a){let i=a,e=!0;for(;e;){e=!1;let s=i.match(/^([`~]{3,})/m);if(!s)break;let t=s[1][0],o=s[1].length,n=s.index,r=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),c=new RegExp(`^${r}{${o}}\\s*$`,"m"),p=i.substring(n+s[1].length).match(c);if(p){let d=n+s[1].length+p.index+p[0].length;i=i.substring(0,n)+i.substring(d),e=!0}else{let u=i.indexOf(`
`,n);u===-1?i=i.substring(0,n):i=i.substring(0,n)+i.substring(u+1),e=!0}}return i}function pt(a){if(!a||a.trim().length===0)return"";a=a.replace(/^>\s*\[![\w-]+\][+-]?.*$/gm,""),a=a.replace(/^>\s?/gm,"");let{text:i,map:e}=rt(a),s=ct(i);return ot.forEach(t=>{s=s.replace(t,(o,...n)=>{if(o.match(/<[a-z][a-z0-9]*\b[^>]*>.*?<\//i))return n[1]||"";if(n.length>0&&n[0]!==void 0){for(let r=0;r<n.length-2;r++)if(typeof n[r]=="string")return n[r]}return""})}),s=lt(s,e),s}function dt(a,i=!1,e,s){let t=a.replace(/^---[\s\S]*?---/,"").trim(),o=pt(t),n=o.indexOf(`
`),r=(n!==-1?o.substring(0,n):o).trim();(i||e&&r===e||s&&r===s)&&(o=n!==-1?o.substring(n+1).trim():"");let c=o.replace(/\^[a-zA-Z0-9-]+/g,"").split(/\s+/).filter(u=>u).join(" ").trim().replace(/\.{2,}/g,u=>u.replace(/\./g,"\u2024")),l=c.length>500,p=c.substring(0,500);return l&&(p+="\u2026"),p}async function Oe(a,i,e,s,t,o){if(e!=null&&(typeof e=="string"||typeof e=="number")&&String(e).trim().length>0)return String(e).trim();if(s.fallbackToContent){let r=await i.vault.cachedRead(a);return dt(r,s.omitFirstLine,t,o)}return""}async function ht(a,i,e,s,t,o,n){if(!(a in o))try{let{internalPaths:r,externalUrls:c}=await Le(s),l=[...Ie(r,a,e),...c];l.length===0&&t&&(l=await me(i,e)),l.length>0&&(o[a]=l.length>1?l:l[0],n[a]=!0)}catch(r){console.error(`Failed to load image for ${a}:`,r)}}async function fe(a,i,e,s,t){let o=a.filter(r=>!(r.path in s)),n=50;for(let r=0;r<o.length;r+=n){let c=o.slice(r,r+n);await Promise.all(c.map(async l=>{await ht(l.path,l.file,e,l.imagePropertyValues,i,s,t)}))}}async function Ne(a,i,e,s){await Promise.all(a.map(async t=>{if(!(t.path in e||s[t.path]))try{let o=await me(t.file,i);o.length>0&&(e[t.path]=o.length>1?o:o[0],s[t.path]=!0)}catch(o){console.error(`Failed to load embed images for ${t.path}:`,o)}}))}async function Re(a,i,e,s,t){await Promise.all(a.map(async o=>{if(!(o.path in t))try{o.file.extension==="md"?t[o.path]=await Oe(o.file,s,o.descriptionData,{fallbackToContent:i,omitFirstLine:e},o.fileName,o.titleString):t[o.path]=""}catch(n){console.error(`Failed to load snippet for ${o.path}:`,n),t[o.path]=""}}))}var Z=require("obsidian");function ut(a,i){let e=null,s=!1;if(i.draftStatusUseFilenamePrefix&&a.file&&a.file.name)e=a.file.name.startsWith("_"),s=i.draftStatusReverse?!e:e;else if(i.draftStatusProperty){let t=L(a,i.draftStatusProperty);if(t){let o=t;o&&"data"in o&&typeof o.data=="boolean"&&(e=o.data,s=i.draftStatusReverse?!e:e)}}return{booleanValue:e,isDraft:s}}function G(a,i,e,s,t){if(!s.showDraftStatus)return;let{booleanValue:o,isDraft:n}=ut(i,s);if(o!==null){let r=a.createDiv("card-status-badge");n?(r.addClass("status-draft"),r.appendText("Draft")):(r.addClass("status-published"),r.appendText("Published")),t&&(r.addClass("bases-cms-cursor-pointer"),r.addEventListener("click",c=>{c.stopPropagation(),t(e,"draft",!o)}))}}var F=require("obsidian");function gt(a,i){let e=new F.Modal(a);e.titleEl.setText("Rename file");let s=e.contentEl.createDiv();s.style.width="100%";let t=new F.TextComponent(s);t.setValue(i.basename),t.inputEl.style.width="100%",t.inputEl.style.boxSizing="border-box",t.inputEl.focus(),t.inputEl.select();let o=e.contentEl.createDiv({cls:"modal-button-container"});o.createEl("button",{text:"Cancel"}).addEventListener("click",()=>e.close());let r=o.createEl("button",{text:"Rename",cls:"mod-cta"}),c=async()=>{let l=t.getValue().trim();if(!l||l===i.basename){e.close();return}let p=i.path.split("/");p[p.length-1]=l+(i.extension?`.${i.extension}`:"");let u=p.join("/");try{await a.fileManager.renameFile(i,u),e.close()}catch(d){console.error("[Bases CMS] Error renaming file:",d),e.close()}};r.addEventListener("click",()=>{c()}),t.inputEl.addEventListener("keydown",l=>{l.key==="Enter"?(l.preventDefault(),c()):l.key==="Escape"&&(l.preventDefault(),e.close())}),e.open()}function mt(a){let i=a.toLowerCase();return a==="file-explorer:rename-file"||a==="rename-file"||a==="file:rename-file"||i.includes("rename")&&i.includes("file")&&!i.includes(":")}function ft(a,i){let e=a.toLowerCase(),s=i.toLowerCase();return["add tag","add-tag","insert-template","insert-template","editor:","markdown:"].some(o=>e.includes(o)||s.includes(o))}function Ve(a,i,e,s,t,o){if(!i.settings.enableQuickEdit||!i.settings.quickEditCommand||i.settings.quickEditCommand===""||o.hideQuickEditIcon)return;let n=e.createSpan("bases-cms-quick-edit-icon");n.addClass("bases-cms-cursor-default"),(0,F.setIcon)(n,i.settings.quickEditIcon||"pencil-line"),e.addEventListener("click",r=>{n.contains(r.target)&&(r.stopPropagation(),r.stopImmediatePropagation())},!0),s.addEventListener("click",r=>{(async()=>{var p,u,d,h;let c=r.target;if(!n.contains(c)&&!c.closest(".bases-cms-quick-edit-icon"))return;r.stopPropagation(),r.stopImmediatePropagation(),r.preventDefault();let l=a.vault.getAbstractFileByPath(t);if(l instanceof F.TFile){let g=i.settings.quickEditCommand,y=a.commands,k=(p=y==null?void 0:y.commands)==null?void 0:p[g],E=(k==null?void 0:k.name)||"",v=E.toLowerCase();if(mt(g)||v.includes("rename")&&v.includes("file")){gt(a,l);return}if(ft(g,E)&&!i.settings.quickEditOpenFile){new F.Notice(`The "${E}" command requires the file to be open in an editor. Enable "Attempt to open file and execute quick edit command" in settings to try anyway.`,5e3);return}let m=!1;try{let w=null,f=g;if(g.includes(":")){let T=g.split(":");w=T[0],f=T.slice(1).join(":")}else{let C=a.commands,S=(u=C==null?void 0:C.commands)==null?void 0:u[g];if(S){let P=S.plugin||S.sourcePlugin;P&&(w=((d=P.manifest)==null?void 0:d.id)||P.pluginId||null)}}if(w){let T=a.plugins,C=(h=T==null?void 0:T.plugins)==null?void 0:h[w];if(C){let S=f.split("-").map((P,b)=>b===0?P:P.charAt(0).toUpperCase()+P.slice(1)).join("")+"ByPath";if(C&&typeof C[S]=="function"){await C[S](t),m=!0;return}}}}catch(w){}if(!m){if(!i.settings.quickEditOpenFile){new F.Notice(`This command doesn't have special handling. Enable "Attempt to open file and execute quick edit command" in settings to try executing it.`,5e3);return}let w=a.workspace.getLeaf(!1);await w.openFile(l),a.workspace.setActiveLeaf(w,{focus:!0});let f=0,T=30,C=()=>{a.workspace.getActiveFile()===l&&(async()=>{var b,A;try{await((A=(b=a.commands)==null?void 0:b.executeCommandById)==null?void 0:A.call(b,i.settings.quickEditCommand))}catch(M){}})()},S=()=>{let P=w.view,b=P,A=a.workspace.getActiveFile();P&&"editor"in P&&b.editor&&A===l?requestAnimationFrame(()=>{requestAnimationFrame(()=>{setTimeout(()=>{C()},200)})}):f<T&&(f++,setTimeout(S,50))};S()}}})()},!0),n.addEventListener("mousedown",r=>{r.stopPropagation(),r.stopImmediatePropagation(),r.preventDefault()},!0)}var $e=require("obsidian");var K=class{constructor(i,e,s){this.app=i;this.getBasesConfig=e;this.getBasesController=s}renderProperties(i,e,s,t,o){let n=[t.propertyDisplay1,t.propertyDisplay2,t.propertyDisplay3,t.propertyDisplay4],r=new Set,c=n.map(h=>!h||h===""||r.has(h)?"":(r.add(h),h)),l=c.map(h=>h?_(h,s,e,t):null),p=c[0]!==""||c[1]!=="",u=c[2]!==""||c[3]!=="";if(!p&&!u)return;let d=i.createDiv("card-properties properties-4field");if(p){let h=d.createDiv("property-row property-row-1");t.propertyLayout12SideBySide&&h.addClass("property-row-side-by-side");let g=h.createDiv("property-field property-field-1");c[0]&&this.renderPropertyContent(g,c[0],l[0],e,s,t,o);let y=h.createDiv("property-field property-field-2");c[1]&&this.renderPropertyContent(y,c[1],l[1],e,s,t,o)}if(u){let h=d.createDiv("property-row property-row-2");t.propertyLayout34SideBySide&&h.addClass("property-row-side-by-side");let g=h.createDiv("property-field property-field-3");c[2]&&this.renderPropertyContent(g,c[2],l[2],e,s,t,o);let y=h.createDiv("property-field property-field-4");c[3]&&this.renderPropertyContent(y,c[3],l[3],e,s,t,o)}}renderPropertyContent(i,e,s,t,o,n,r){if(e===""||!s&&n.propertyLabels==="hide"||n.propertyLabels==="hide"&&((e==="tags"||e==="note.tags")&&t.yamlTags.length===0||(e==="file.tags"||e==="file tags")&&t.tags.length===0||(e==="file.path"||e==="path"||e==="file path")&&t.folderPath.length===0))return;let c=this.getBasesConfig?this.getBasesConfig():void 0,l=this.getBasesController?this.getBasesController():void 0,p=De(e,this.app,c,l),u=p.toLowerCase()!==e.toLowerCase();if(n.propertyLabels==="above"){let g=i.createDiv("property-label");u&&g.addClass("property-label-custom"),g.textContent=p}let d=i.createDiv("property-content");if(n.propertyLabels==="inline"){let g=d.createSpan("property-label-inline");g.textContent=p+": "}if(!s){d.appendText("\u2026");return}if(e==="file.mtime"||e==="file.ctime"||e==="modified time"||e==="created time")d.createSpan().appendText(s);else if((e==="tags"||e==="note.tags")&&t.yamlTags.length>0){let g=d.createDiv("tags-wrapper");t.yamlTags.forEach(y=>{g.createEl("a",{cls:"tag",text:y,href:"#"}).addEventListener("click",E=>{var m,w,f;E.preventDefault();let v=(w=(m=this.app.internalPlugins)==null?void 0:m.plugins)==null?void 0:w["global-search"];(f=v==null?void 0:v.instance)!=null&&f.openGlobalSearch&&v.instance.openGlobalSearch("tag:"+y)})})}else if((e==="file.tags"||e==="file tags")&&t.tags.length>0){let g=d.createDiv("tags-wrapper");t.tags.forEach(y=>{g.createEl("a",{cls:"tag",text:y,href:"#"}).addEventListener("click",E=>{var m,w,f;E.preventDefault();let v=(w=(m=this.app.internalPlugins)==null?void 0:m.plugins)==null?void 0:w["global-search"];(f=v==null?void 0:v.instance)!=null&&f.openGlobalSearch&&v.instance.openGlobalSearch("tag:"+y)})})}else if((e==="file.path"||e==="path"||e==="file path")&&t.path.length>0){let g=d.createDiv("path-wrapper"),y=t.path.split("/").filter(k=>k);y.forEach((k,E)=>{let v=g.createSpan(),m=E===y.length-1,w=m?"path-segment filename-segment":"path-segment file-path-segment";v.createSpan({cls:w,text:k}).addEventListener("click",T=>{if(T.stopPropagation(),m){let C=this.app.vault.getAbstractFileByPath(t.path);C instanceof $e.TFile&&this.app.workspace.getLeaf(!1).openFile(C)}}),E<y.length-1&&v.createSpan({cls:"path-separator",text:"/"})})}else{let g=this.app.metadataCache,k=(typeof g.getAllPropertyInfos=="function"?g.getAllPropertyInfos():{})[e.toLowerCase()],E=o.getValue(e);if(((k==null?void 0:k.widget)==="checkbox"||E&&"data"in E&&typeof E.data=="boolean")&&r){let m=d.createEl("input",{type:"checkbox"});m.checked=E&&"data"in E?Boolean(E.data):!1,d.createSpan({text:p}),m.addEventListener("change",async w=>{w.stopPropagation();let f=m.checked;try{let T=e.startsWith("note.")?e.substring(5):e;await r(t.path,T,f)}catch(T){console.error("Error toggling property:",T),m.checked=!f}}),m.addEventListener("click",w=>{w.stopPropagation()})}else d.createDiv("text-wrapper").appendText(s)}(!d.textContent||d.textContent.trim().length===0)&&d.remove()}};var J=class{constructor(i,e,s,t,o,n){this.app=i;this.plugin=e;this.propertyObservers=s;this.updateLayoutRef=t;this.basesConfig=o,this.basesController=n,this.propertyRenderer=new K(this.app,()=>this.basesConfig,()=>this.basesController)}renderCard(i,e,s,t,o,n,r,c){let l=i.createDiv("card bases-cms-card");t.imageFormat==="cover"?l.classList.add("image-format-cover"):t.imageFormat==="thumbnail"&&l.classList.add("image-format-thumbnail"),l.setAttribute("data-path",e.path),l.setAttribute("data-href",e.path),l.addClass("bases-cms-cursor-pointer");let p=l.createDiv("bases-cms-select-checkbox"),u=p.createEl("input",{type:"checkbox",cls:"selection-checkbox"});if(u.checked=n,u.addEventListener("change",d=>{d.stopPropagation(),d.stopImmediatePropagation(),r(e.path,u.checked)}),u.addEventListener("click",d=>{d.stopPropagation(),d.stopImmediatePropagation()}),t.showDraftStatus&&t.imageFormat!=="cover"&&G(l,s,e.path,t,c),l.addEventListener("click",d=>{let h=d.target;if(h.closest(".bases-cms-quick-edit-icon")){d.stopPropagation(),d.stopImmediatePropagation(),d.preventDefault();return}if(p.contains(h)||h.tagName==="INPUT"||h.closest("input")||h.closest(".bases-cms-property")||h.closest(".card-status-badge"))return;let y=d.metaKey||d.ctrlKey;this.app.workspace.openLinkText(e.path,"",y)}),l.addEventListener("contextmenu",d=>{let h=d.target;if(p.contains(h)||h.tagName==="INPUT"||h.closest("input")||h.closest(".bases-cms-property")||h.closest(".card-status-badge")||h.closest(".bases-cms-quick-edit-icon"))return;let g=this.app.vault.getAbstractFileByPath(e.path);if(g&&g instanceof Z.TFile){d.stopPropagation();let y=new Z.Menu;this.app.workspace.trigger("file-menu",y,g,"bases"),y.showAtMouseEvent(d)}}),t.showTitle){let d=l.createDiv("card-title");d.appendText(e.title),Ve(this.app,this.plugin,d,l,e.path,t)}if(t.showDate&&t.dateProperty){let d=L(s,t.dateProperty);if(d){let h=d,g="";if(h&&"date"in h&&h.date instanceof Date)g=h.date.toLocaleDateString();else if(h&&"data"in h&&h.data){let y=h.data;if(y instanceof Date)g=y.toLocaleDateString();else if(typeof y=="string"||typeof y=="number"){let k=new Date(y);isNaN(k.getTime())?g=String(y):g=k.toLocaleDateString()}}g&&l.createDiv("card-date").appendText(g)}}if(t.showTextPreview||t.showTags&&e.displayTags&&e.displayTags.length>0||t.imageFormat!=="none"&&(e.imageUrl||e.hasImageAvailable)||t.imageFormat==="cover"){let d=l.createDiv("card-content");if(t.imageFormat==="thumbnail"){let h=d.createDiv("card-text-wrapper");if(t.showTextPreview){let g=h.createDiv("card-text-preview");e.snippet&&g.setText(e.snippet),l.__textPreviewEl=g,l.__cardPath=e.path}if(t.showTags&&e.displayTags&&e.displayTags.length>0){let g=h.createDiv("card-tags"),y=t.maxTagsToShow,k=e.displayTags.slice(0,y),E=e.displayTags.length-y;k.forEach(v=>{g.createSpan("card-tag").appendText(v)}),E>0&&g.createSpan("card-tag-more").appendText(`+${E} more`)}}else{if(t.showTextPreview){let h=d.createDiv("card-text-preview");e.snippet&&h.setText(e.snippet),l.__textPreviewEl=h,l.__cardPath=e.path}if(t.showTags&&e.displayTags&&e.displayTags.length>0){let h=d.createDiv("card-tags"),g=t.maxTagsToShow,y=e.displayTags.slice(0,g),k=e.displayTags.length-g;y.forEach(E=>{h.createSpan("card-tag").appendText(E)}),k>0&&h.createSpan("card-tag-more").appendText(`+${k} more`)}}if(t.imageFormat!=="none"&&e.imageUrl){let g=(Array.isArray(e.imageUrl)?e.imageUrl:[e.imageUrl]).filter(E=>E&&typeof E=="string"&&E.trim().length>0),y=t.imageFormat==="cover"?"card-cover":"card-thumbnail",k=d.createDiv(y);if(g.length>0){let E=k.createDiv("image-embed"),v=E.createEl("img",{attr:{alt:"",decoding:"async",sizes:t.imageFormat==="cover"?"100vw":"80px"}});return E.style.setProperty("--cover-image-url",`url("${g[0]}")`),t.showDraftStatus&&t.imageFormat==="cover"&&G(k,s,e.path,t,c),this.propertyRenderer.renderProperties(l,e,s,t,c),{img:v,src:g[0]}}}else if(t.imageFormat==="cover"){let h=d.createDiv("card-cover-placeholder");G(h,s,e.path,t,c)}}return this.propertyRenderer.renderProperties(l,e,s,t,c),null}};var We=require("obsidian");var O=require("obsidian");async function be(a,i,e,s){await a.fileManager.processFrontMatter(i,t=>{for(let[o,n]of e){if(o==="tags"&&!Object.prototype.hasOwnProperty.call(t,"tags")&&!Array.isArray(n.data)){t[o]=[n.data];continue}if(!t[o]||s){t[o]=n.data;continue}let r=n.type,c=t[o],l=Array.isArray(c)?"list":typeof c=="number"?"number":typeof c=="boolean"?"checkbox":"text";if(bt(r,l)){if(t[o]===n.data||!n.data)continue;let p=yt(t[o],n.data);t[o]=p;continue}else{t[o]=n.data;continue}}})}async function qe(a,i,e){await a.fileManager.processFrontMatter(i,s=>{for(let t of e)s[t]=void 0})}function bt(a,i){let e=["number","date","datetime","checkbox"];return!(e.includes(a)||e.includes(i))}function yt(...a){let e=a.map(t=>Array.isArray(t)?t:[t]).flat();return[...new Set(e)]}var I=class{constructor(i){this.app=i}async setDraft(i,e,s){await this.batchProcessFiles(i,async t=>{if(s)if(s.draftStatusUseFilenamePrefix){let o=t.basename,n=o.startsWith("_"),c=t.path.split("/"),l=e;if(s.draftStatusReverse&&(l=!e),l===!0){if(!n){let p=`_${o}${t.extension?`.${t.extension}`:""}`;c[c.length-1]=p;let u=c.join("/");await this.app.fileManager.renameFile(t,u)}}else if(n){let p=o.substring(1)+(t.extension?`.${t.extension}`:"");c[c.length-1]=p;let u=c.join("/");await this.app.fileManager.renameFile(t,u)}}else{let o=s.draftStatusProperty&&s.draftStatusProperty.trim()?s.draftStatusProperty.startsWith("note.")?s.draftStatusProperty.substring(5):s.draftStatusProperty:"draft",n=e;s.draftStatusReverse&&(n=!e),await this.app.fileManager.processFrontMatter(t,r=>{r[o]=n})}else await this.app.fileManager.processFrontMatter(t,o=>{o.draft=e})}),new O.Notice(`Set ${i.length} file${i.length!==1?"s":""} to ${e?"draft":"published"}`)}async addTags(i,e){let s=new Map;s.set("tags",{type:"tags",data:e,overwrite:!1,delimiter:","}),await this.batchProcessFiles(i,async t=>{await be(this.app,t,s,!1)}),new O.Notice(`Added tags to ${i.length} file${i.length!==1?"s":""}`)}async removeTags(i,e){await this.batchProcessFiles(i,async s=>{let t=this.app.metadataCache.getFileCache(s),o=t==null?void 0:t.frontmatter;if(o!=null&&o.tags){let r=(Array.isArray(o.tags)?o.tags:[o.tags]).filter(c=>!e.includes(c));await this.app.fileManager.processFrontMatter(s,c=>{r.length>0?c.tags=r:c.tags=void 0})}}),new O.Notice(`Removed tags from ${i.length} file${i.length!==1?"s":""}`)}async setProperty(i,e,s,t="text"){let o=e.startsWith("note.")?e.substring(5):e,n=new Map;n.set(o,{type:t,data:s,overwrite:!0,delimiter:","}),await this.batchProcessFiles(i,async r=>{await be(this.app,r,n,!0)}),new O.Notice(`Set ${o} on ${i.length} file${i.length!==1?"s":""}`)}async removeProperty(i,e){let s=e.startsWith("note.")?e.substring(5):e;await this.batchProcessFiles(i,async t=>{await qe(this.app,t,[s])}),new O.Notice(`Removed ${s} from ${i.length} file${i.length!==1?"s":""}`)}async batchProcessFiles(i,e){let s=0,t=i.length;for(let o of i){let n=this.app.vault.getAbstractFileByPath(o);if(n instanceof O.TFile)try{await e(n),s++}catch(r){console.error(`Error processing ${o}:`,r)}}s<t&&new O.Notice(`Processed ${s} of ${t} files`)}};var N=require("obsidian");var X=class extends N.Modal{constructor(e,s){super(e);this.tagsToAdd="";this.tagsToRemove=new Set;this.files=s,this.bulkOps=new I(e)}onOpen(){let{contentEl:e}=this;e.empty(),new N.Setting(e).setName("Manage tags").setHeading(),e.createEl("p",{text:`Managing tags for ${this.files.length} file${this.files.length!==1?"s":""}`}),new N.Setting(e).setName("Add tags").setDesc("Enter tags to add (comma-separated).").addText(c=>{c.setPlaceholder("tag1, tag2, tag3").onChange(l=>{this.tagsToAdd=l})}),e.createEl("h3",{text:"Remove tags"});let s=e.createDiv(),t=new Set;for(let c of this.files){let l=this.app.vault.getAbstractFileByPath(c);if(l instanceof N.TFile){let p=this.app.metadataCache.getFileCache(l),u=p==null?void 0:p.frontmatter;u!=null&&u.tags&&(Array.isArray(u.tags)?u.tags:[u.tags]).forEach(h=>t.add(h))}}for(let c of Array.from(t).sort())new N.Setting(s).setName(c).addToggle(l=>{l.setValue(this.tagsToRemove.has(c)).onChange(p=>{p?this.tagsToRemove.add(c):this.tagsToRemove.delete(c)})});let o=e.createDiv();o.addClass("bases-cms-modal-button-container");let n=o.createEl("button");n.setText("Cancel"),n.addEventListener("click",()=>this.close());let r=o.createEl("button");r.setText("Apply"),r.addClass("mod-cta"),r.addEventListener("click",()=>{(async()=>(await this.applyChanges(),this.close()))()})}async applyChanges(){if(this.tagsToAdd.trim()){let e=this.tagsToAdd.split(",").map(s=>s.trim()).filter(s=>s.length>0);e.length>0&&await this.bulkOps.addTags(this.files,e)}this.tagsToRemove.size>0&&await this.bulkOps.removeTags(this.files,Array.from(this.tagsToRemove))}onClose(){let{contentEl:e}=this;e.empty()}};var V=require("obsidian");var Y=class extends V.Modal{constructor(e,s){super(e);this.propertyName="";this.propertyValue="";this.propertyType="text";this.files=s,this.bulkOps=new I(e)}onOpen(){let{contentEl:e}=this;e.empty(),new V.Setting(e).setName("Set property").setHeading(),e.createEl("p",{text:`Setting property on ${this.files.length} file${this.files.length!==1?"s":""}`}),new V.Setting(e).setName("Property name").setDesc("Enter the property name to set.").addText(n=>{n.setPlaceholder("Enter name").onChange(r=>{this.propertyName=r})}),new V.Setting(e).setName("Property type").setDesc("Select the property type.").addDropdown(n=>{n.addOption("text","Text").addOption("number","Number").addOption("checkbox","Checkbox").addOption("date","Date").setValue(this.propertyType).onChange(r=>{this.propertyType=r})}),new V.Setting(e).setName("Property value").setDesc("Enter the property value.").addText(n=>{n.setPlaceholder("Enter value").onChange(r=>{this.propertyValue=r})});let s=e.createDiv();s.addClass("bases-cms-modal-button-container");let t=s.createEl("button");t.setText("Cancel"),t.addEventListener("click",()=>this.close());let o=s.createEl("button");o.setText("Apply"),o.addClass("mod-cta"),o.addEventListener("click",()=>{(async()=>this.propertyName&&this.propertyValue&&(await this.applyChanges(),this.close()))()})}async applyChanges(){let e=this.propertyValue;this.propertyType==="number"?e=Number(this.propertyValue):this.propertyType==="checkbox"?e=this.propertyValue.toLowerCase()==="true"||this.propertyValue==="1":this.propertyType==="date"&&(e=this.propertyValue),await this.bulkOps.setProperty(this.files,this.propertyName,e,this.propertyType)}onClose(){let{contentEl:e}=this;e.empty()}};var $=require("obsidian");var ee=class extends $.Modal{constructor(e,s){super(e);this.propertiesToRemove=new Set;this.files=s,this.bulkOps=new I(e)}onOpen(){let{contentEl:e}=this;e.empty(),new $.Setting(e).setName("Remove property").setHeading(),e.createEl("p",{text:`Removing properties from ${this.files.length} file${this.files.length!==1?"s":""}`});let s=new Set;for(let c of this.files){let l=this.app.vault.getAbstractFileByPath(c);if(l instanceof $.TFile){let p=this.app.metadataCache.getFileCache(l),u=p==null?void 0:p.frontmatter;if(u)for(let d in u)d!=="tags"&&d!=="title"&&s.add(d)}}let t=e.createDiv();for(let c of Array.from(s).sort())new $.Setting(t).setName(c).addToggle(l=>{l.setValue(this.propertiesToRemove.has(c)).onChange(p=>{p?this.propertiesToRemove.add(c):this.propertiesToRemove.delete(c)})});s.size===0&&e.createEl("p",{text:"No properties found in selected files."});let o=e.createDiv();o.addClass("bases-cms-modal-button-container");let n=o.createEl("button");n.setText("Cancel"),n.addEventListener("click",()=>this.close());let r=o.createEl("button");r.setText("Apply"),r.addClass("mod-cta"),r.addEventListener("click",()=>{(async()=>this.propertiesToRemove.size>0&&(await this.applyChanges(),this.close()))()})}async applyChanges(){for(let e of this.propertiesToRemove)await this.bulkOps.removeProperty(this.files,e)}onClose(){let{contentEl:e}=this;e.empty()}};var ie=require("obsidian");var R=require("obsidian");var q=require("obsidian");function _e(a,i){let e=[],s=a.vault.getAbstractFileByPath(i.path);if(s instanceof q.TFile){let t=a.metadataCache.getFileCache(s),o=(t==null?void 0:t.embeds)||[];for(let n of o){let r=a.metadataCache.getFirstLinkpathDest(n.link,i.path);r instanceof q.TFile&&e.push(r)}}return e}function ze(a,i){let e=[];for(let s of i.children)s instanceof q.TFile&&s.extension==="md"?e.push(..._e(a,s)):s instanceof q.TFolder&&e.push(...ze(a,s));return e}async function vt(a,i,e,s){let t=a.vault.getMarkdownFiles().filter(c=>c.path!==e.path),o=i.path,n=i.name,r=i.basename;for(let c of t){if(s&&c.path.startsWith(s.path+"/"))continue;let l=await a.vault.read(c);if(l.includes(o)||l.includes(n)||l.includes(r)||l.includes(`![[${n}]]`)||l.includes(`[[${n}]]`)||l.includes(`(${n})`)||l.includes(`(${o})`))return!0}return!1}async function He(a,i,e){let s=[];s.push(..._e(a,i)),e&&s.push(...ze(a,e));let t=Array.from(new Set(s.map(n=>n.path))).map(n=>a.vault.getAbstractFileByPath(n)).filter(n=>n instanceof q.TFile),o=[];for(let n of t)await vt(a,n,i,e)||o.push(n);return o}function wt(a,i){let e=i.deleteParentFolderFilename||"index";return a.basename===e&&a.parent!==null}function Ue(a,i){return i.deleteParentFolder&&wt(a,i)}async function ye(a,i,e){let s=[],t=[],o=[];for(let c of i){let l=a.vault.getAbstractFileByPath(c);if(l instanceof R.TFile){if(Ue(l,e)){let p=l.parent;if(p&&!t.includes(p)){t.push(p);let u=p.children.filter(d=>d instanceof R.TFile);s.push(...u)}}else s.push(l);if(e.deleteUniqueAttachments){let p=Ue(l,e)&&l.parent||void 0,u=await He(a,l,p);o.push(...u)}}}let n=Array.from(new Set(s.map(c=>c.path))).map(c=>a.vault.getAbstractFileByPath(c)).filter(c=>c instanceof R.TFile),r=Array.from(new Set(o.map(c=>c.path))).map(c=>a.vault.getAbstractFileByPath(c)).filter(c=>c instanceof R.TFile);return{filesToDelete:n,foldersToDelete:Array.from(new Set(t)),attachmentsToDelete:r}}async function te(a,i){let e=0,s=0;for(let t of i.filesToDelete)try{await a.fileManager.trashFile(t),e++}catch(o){console.error(`Error deleting file ${t.path}:`,o),s++}for(let t of i.attachmentsToDelete)try{await a.fileManager.trashFile(t),e++}catch(o){console.error(`Error deleting attachment ${t.path}:`,o),s++}for(let t of i.foldersToDelete)try{await a.fileManager.trashFile(t),e++}catch(o){console.error(`Error deleting folder ${t.path}:`,o),s++}s>0?new R.Notice(`Deleted ${e} items, ${s} errors occurred`):new R.Notice(`Successfully deleted ${e} item${e!==1?"s":""}`)}var se=class extends ie.Modal{constructor(e,s,t){super(e);this.preview=s,this.onConfirm=t}onOpen(){let{contentEl:e}=this;if(e.empty(),new ie.Setting(e).setName("Confirm deletion").setHeading(),e.createEl("p",{text:"The following items will be deleted:",cls:"bases-cms-deletion-warning"}),this.preview.filesToDelete.length>0){e.createEl("h3",{text:`Files (${this.preview.filesToDelete.length})`});let n=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.filesToDelete.slice(0,20))n.createEl("li").setText(r.path);this.preview.filesToDelete.length>20&&n.createEl("li",{text:`... and ${this.preview.filesToDelete.length-20} more files`})}if(this.preview.foldersToDelete.length>0){e.createEl("h3",{text:`Folders (${this.preview.foldersToDelete.length})`});let n=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.foldersToDelete)n.createEl("li").setText(r.path)}if(this.preview.attachmentsToDelete.length>0){e.createEl("h3",{text:`Attachments (${this.preview.attachmentsToDelete.length})`});let n=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let r of this.preview.attachmentsToDelete.slice(0,20))n.createEl("li").setText(r.path);this.preview.attachmentsToDelete.length>20&&n.createEl("li",{text:`... and ${this.preview.attachmentsToDelete.length-20} more attachments`})}e.createEl("p",{text:"This action cannot be undone.",cls:"bases-cms-deletion-warning"});let s=e.createDiv();s.addClass("bases-cms-modal-button-container");let t=s.createEl("button");t.setText("Cancel"),t.addEventListener("click",()=>this.close());let o=s.createEl("button");o.setText("Delete"),o.addClass("mod-cta"),o.addClass("destructive"),o.addEventListener("click",()=>{(async()=>(await te(this.app,this.preview),this.onConfirm(),this.close()))()})}onClose(){let{contentEl:e}=this;e.empty()}};var ne=require("obsidian"),H=class extends ne.Modal{constructor(e,s,t,o){super(e);this.files=s,this.operation=t,this.onConfirm=o}onOpen(){let{contentEl:e}=this;e.empty();let s=this.operation==="draft"?"mark as draft":"mark as published",t=s.charAt(0).toUpperCase()+s.slice(1);if(new ne.Setting(e).setName(`Confirm ${t}`).setHeading(),e.createEl("p",{text:`Are you sure you want to ${s} ${this.files.length} file${this.files.length!==1?"s":""}?`}),this.files.length>0){let c=e.createEl("ul",{cls:"bases-cms-deletion-list"});for(let l of this.files.slice(0,20))c.createEl("li").setText(l);this.files.length>20&&c.createEl("li",{text:`... and ${this.files.length-20} more file${this.files.length-20!==1?"s":""}`})}let o=e.createDiv();o.addClass("bases-cms-modal-button-container");let n=o.createEl("button");n.setText("Cancel"),n.addEventListener("click",()=>this.close());let r=o.createEl("button");r.setText("Confirm"),r.addClass("mod-cta"),r.addEventListener("click",()=>{this.onConfirm(),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var ae=class{constructor(i,e,s,t,o,n){this.app=i;this.plugin=e;this.getSelectedFiles=s;this.clearSelection=t;this.refreshView=o;this.showToolbar=n;this.bulkOps=new I(i)}async handleSetDraft(i){let e=this.getSelectedFiles();e.length!==0&&(this.plugin.settings.confirmBulkOperations?new H(this.app,e,"draft",()=>{(async()=>(await this.bulkOps.setDraft(e,!0,i),this.refreshView()))()}).open():(await this.bulkOps.setDraft(e,!0,i),this.refreshView()))}async handlePublish(i){let e=this.getSelectedFiles();e.length!==0&&(this.plugin.settings.confirmBulkOperations?new H(this.app,e,"publish",()=>{(async()=>(await this.bulkOps.setDraft(e,!1,i),this.refreshView()))()}).open():(await this.bulkOps.setDraft(e,!1,i),this.refreshView()))}handleManageTags(){let i=this.getSelectedFiles();if(i.length===0)return;let e=new X(this.app,i);e.onClose=()=>{this.showToolbar(),this.refreshView()},e.open()}handleSetProperty(){let i=this.getSelectedFiles();if(i.length===0)return;let e=new Y(this.app,i);e.onClose=()=>{this.showToolbar(),this.refreshView()},e.open()}handleRemoveProperty(){let i=this.getSelectedFiles();if(i.length===0)return;let e=new ee(this.app,i);e.onClose=()=>{this.showToolbar(),this.refreshView()},e.open()}async handleDelete(){let i=this.getSelectedFiles();if(i.length!==0)if(this.plugin.settings.confirmDeletions){let e=await ye(this.app,i,this.plugin.settings);new se(this.app,e,()=>{this.clearSelection(),this.refreshView()}).open()}else{let e=await ye(this.app,i,this.plugin.settings);await te(this.app,e),this.clearSelection(),this.refreshView()}}};var oe=class{constructor(i,e,s,t,o,n,r,c){this.app=i;this.plugin=e;this.container=s;this.getSelectedFiles=t;this.clearSelection=o;this.refreshView=n;this.toolbarEl=null;this.countEl=null;this.resizeObserver=null;this.timeoutIds=[];this.selectAllCallback=r,this.settings=c,this.actions=new ae(this.app,this.plugin,this.getSelectedFiles,this.clearSelection,this.refreshView,()=>this.show()),this.createToolbar()}updateSettings(i){this.settings=i}createToolbar(){this.toolbarEl=document.createElement("div"),this.toolbarEl.className="bases-toolbar bases-cms-bulk-toolbar bases-cms-bulk-toolbar-hidden",this.toolbarEl.__bulkToolbarInstance=this,this.createToolbarContent(),this.positionToolbar();let i=window.setTimeout(()=>this.positionToolbar(),100);this.timeoutIds.push(i)}positionToolbar(){if(!this.toolbarEl)return;let i=this.container.closest(".bases-header");if(!i){let s=this.container.parentElement;for(;s&&!i;){if(s.classList.contains("bases-header")){i=s;break}s=s.parentElement}}if(!i){let s=Array.from(document.querySelectorAll(".bases-header"));for(let t of s)if(t.contains(this.container)){i=t;break}}let e=this.container.closest(".view-content");if(e)this.toolbarEl.parentElement!==e?(this.toolbarEl.parentElement&&this.toolbarEl.remove(),e.insertBefore(this.toolbarEl,this.container)):this.toolbarEl.nextSibling!==this.container&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),e.insertBefore(this.toolbarEl,this.container));else if(i&&i.parentElement)this.toolbarEl.parentElement!==i.parentElement&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),i.parentElement.insertBefore(this.toolbarEl,i.nextSibling));else{let s=this.container.parentElement;s&&(this.toolbarEl.parentElement!==s||this.toolbarEl.nextSibling!==this.container)&&(this.toolbarEl.parentElement&&this.toolbarEl.remove(),s.insertBefore(this.toolbarEl,this.container))}}createToolbarContent(){if(!this.toolbarEl)return;let i=this.toolbarEl.createDiv("bases-cms-bulk-toolbar-left"),e=(o,n,r,c,l=!1)=>{let u=c.createDiv("bases-toolbar-item").createDiv("text-icon-button");l&&u.addClass("destructive"),u.setAttribute("tabindex","0");let d=u.createSpan("text-button-icon");return(0,We.setIcon)(d,o),u.createSpan("text-button-label").setText(n),u.addEventListener("click",r),u};this.plugin.settings.showToolbarSelectAll&&e("copy-check","Select all",()=>this.handleSelectAll(),i),this.plugin.settings.showToolbarClear&&e("square-x","Clear",()=>this.clearSelection(),i);let s=i.createDiv("bases-toolbar-item bases-cms-selected-count");this.countEl=s.createSpan("text-button-label"),this.countEl.setText("0 items selected");let t=this.toolbarEl.createDiv("bases-cms-bulk-toolbar-right");this.plugin.settings.showToolbarPublish&&e("book-check","Publish",()=>{this.actions.handlePublish(this.settings)},t),this.plugin.settings.showToolbarDraft&&e("book-dashed","Draft",()=>{this.actions.handleSetDraft(this.settings)},t),this.plugin.settings.showToolbarTags&&e("tags","Tags",()=>this.actions.handleManageTags(),t),this.plugin.settings.showToolbarSet&&e("list-check","Set",()=>this.actions.handleSetProperty(),t),this.plugin.settings.showToolbarRemove&&e("list-x","Remove",()=>this.actions.handleRemoveProperty(),t),this.plugin.settings.showToolbarDelete&&e("trash-2","Delete",()=>{this.actions.handleDelete()},t,!0),this.setupResponsiveBehavior()}setupResponsiveBehavior(){if(!this.toolbarEl)return;let i=window.setTimeout(()=>{this.updateCollapsedState()},100);this.timeoutIds.push(i),this.toolbarEl&&(this.resizeObserver=new ResizeObserver(()=>{this.updateCollapsedState()}),this.resizeObserver.observe(this.toolbarEl));let e=this.container;if(e){let s=new ResizeObserver(()=>{let t=window.setTimeout(()=>{this.updateCollapsedState()},10);this.timeoutIds.push(t)});s.observe(e),this.containerObserver=s}}updateCollapsedState(){if(!this.toolbarEl)return;this.toolbarEl.offsetWidth<680?this.toolbarEl.addClass("collapsed"):this.toolbarEl.removeClass("collapsed")}updateCount(i){this.countEl&&this.countEl.setText(`${i} item${i!==1?"s":""} selected`)}handleSelectAll(){this.selectAllCallback&&this.selectAllCallback()}show(){if(this.toolbarEl||(console.warn("[Bases CMS] Toolbar element not found, recreating..."),this.createToolbar()),this.toolbarEl){this.positionToolbar(),this.toolbarEl.parentElement||(console.warn("[Bases CMS] Toolbar not in DOM, repositioning..."),this.positionToolbar()),this.toolbarEl.removeClass("bases-cms-bulk-toolbar-hidden"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-visible"),this.toolbarEl.offsetHeight;let i=window.setTimeout(()=>{this.toolbarEl&&(this.toolbarEl.removeClass("bases-cms-bulk-toolbar-animating-out"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-animating-in"))},10);this.timeoutIds.push(i)}else console.error("[Bases CMS] Failed to show toolbar - element is null")}hide(){if(this.toolbarEl){this.toolbarEl.removeClass("bases-cms-bulk-toolbar-animating-in"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-animating-out");let i=window.setTimeout(()=>{this.toolbarEl&&(this.toolbarEl.removeClass("bases-cms-bulk-toolbar-visible"),this.toolbarEl.addClass("bases-cms-bulk-toolbar-hidden"))},200);this.timeoutIds.push(i)}}recreate(){let i=this.toolbarEl&&!this.toolbarEl.hasClass("bases-cms-bulk-toolbar-hidden"),e=0;if(this.countEl&&this.countEl.textContent){let s=this.countEl.textContent.match(/\d+/);s&&(e=parseInt(s[0],10))}this.destroy(),this.createToolbar(),i&&this.toolbarEl&&e>0&&(this.updateCount(e),this.show())}destroy(){this.timeoutIds.forEach(e=>window.clearTimeout(e)),this.timeoutIds=[],this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null);let i=this.containerObserver;i&&(i.disconnect(),this.containerObserver=void 0),this.toolbarEl&&(this.toolbarEl.remove(),this.toolbarEl=null)}};z();function je(a,i,e,s,t){let o=c=>{var k;let l=c.target,p=l.closest(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu");if(!p||l.closest(".bases-cms-bulk-toolbar, .bases-cms-container .card"))return;let u=a.workspace.activeLeaf,d=u==null?void 0:u.view,h=d?d.containerEl:null;if(!(d&&h&&(h===i||((k=p.closest(".workspace-leaf"))==null?void 0:k.contains(h)))))return;let y=D(e,s);y.customizeNewButton&&(c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation(),(async()=>{var w;let E=((w=y.newNoteLocation)==null?void 0:w.trim())||"";if(E===""){let f=a.vault.config,T=(f==null?void 0:f.newFileLocation)||"folder",C=(f==null?void 0:f.newFileFolderPath)||"";console.debug("[CMS View] Obsidian config:",{newFileLocation:T,newFileFolderPath:C});let S="Untitled.md";if(T==="folder"&&C)S=`${C}/Untitled.md`;else if(T==="current"){let b=a.workspace.getActiveFile();b&&b.parent&&(S=`${b.parent.path}/Untitled.md`)}else T==="root"&&(S="Untitled.md");console.debug("[CMS View] Creating file at:",S);let P=await a.vault.create(S,"");await a.workspace.openLinkText(P.path,"",!1);return}if(E==="/"||E.replace(/\//g,"")===""){let f=await a.vault.create("Untitled.md","");await a.workspace.openLinkText(f.path,"",!1);return}let v=E.replace(/^\/+|\/+$/g,""),m=a.vault.getAbstractFileByPath(v);if((!m||!("children"in m))&&(await a.vault.createFolder(v),m=a.vault.getAbstractFileByPath(v)),m&&"children"in m){let f=await a.vault.create(`${v}/Untitled.md`,"");await a.workspace.openLinkText(f.path,"",!1)}})())};document.addEventListener("click",o,!0);let n=new MutationObserver(()=>{document.querySelectorAll(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu").forEach(l=>{let p=l;p.__cmsIntercepted||(p.__cmsIntercepted=!0,l.addEventListener("click",o,!0))})});n.observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll(".bases-toolbar-new-item-menu .text-icon-button, .bases-toolbar-new-item-menu").forEach(c=>{let l=c;l.__cmsIntercepted||(l.__cmsIntercepted=!0,c.addEventListener("click",o,!0))}),t(()=>{document.removeEventListener("click",o,!0),n.disconnect()})}var Qe=require("obsidian");z();var re=class{constructor(i,e,s,t){this.app=i;this.config=e;this.pluginSettings=s;this.onRefresh=t}async handlePropertyToggle(i,e,s){try{let t=this.app.vault.getAbstractFileByPath(i);if(!(t instanceof Qe.TFile))return;let o=e.startsWith("note.")?e.substring(5):e,n=D(this.config,this.pluginSettings),r=n.showDraftStatus&&o==="draft",c=!1;if(r)if(n.draftStatusUseFilenamePrefix){let l=t.basename,p=l.startsWith("_"),d=t.path.split("/");if(s===!0){if(!p){let h=`_${l}${t.extension?`.${t.extension}`:""}`;d[d.length-1]=h;let g=d.join("/");await this.app.fileManager.renameFile(t,g),c=!0}}else if(p){let h=l.substring(1)+(t.extension?`.${t.extension}`:"");d[d.length-1]=h;let g=d.join("/");await this.app.fileManager.renameFile(t,g),c=!0}}else{let l=n.draftStatusProperty&&n.draftStatusProperty.trim()?n.draftStatusProperty.startsWith("note.")?n.draftStatusProperty.substring(5):n.draftStatusProperty:"draft";await this.app.fileManager.processFrontMatter(t,p=>{p[l]=s}),c=!0}else await this.app.fileManager.processFrontMatter(t,l=>{l[o]=s}),c=!0;c&&requestAnimationFrame(()=>{window.setTimeout(()=>{try{this.onRefresh()}catch(l){console.error("Error refreshing view after property toggle:",l)}},100)})}catch(t){console.error("Error toggling property:",t)}}};z();var le=class{constructor(i,e,s,t,o,n){this.containerEl=i;this.app=e;this.config=s;this.pluginSettings=t;this.onLoadMore=o;this.registerCleanup=n;this.scrollListener=null;this.scrollThrottleTimeout=null;this.resizeObserver=null;this.windowResizeHandler=null;this.isLoading=!1;this.displayedCount=50;this.totalEntries=0;var c;let r=(c=this.app.isMobile)!=null?c:!1;this.displayedCount=r?25:50}setDisplayedCount(i){this.displayedCount=i}getDisplayedCount(){return this.displayedCount}setIsLoading(i){this.isLoading=i}setupInfiniteScroll(i){this.totalEntries=i,this.scrollListener&&(this.containerEl.removeEventListener("scroll",this.scrollListener),this.scrollListener=null),!(this.displayedCount>=i)&&(this.scrollListener=()=>{var l;if(this.scrollThrottleTimeout!==null||this.isLoading)return;let e=this.containerEl.scrollTop,s=this.containerEl.scrollHeight,t=this.containerEl.clientHeight,o=s-(e+t),r=((l=this.app.isMobile)!=null?l:!1)?1:2,c=t*r;if(o<c&&this.displayedCount<i){this.isLoading=!0;let p=50;this.displayedCount=Math.min(this.displayedCount+p,i),this.onLoadMore()}this.scrollThrottleTimeout=window.setTimeout(()=>{this.scrollThrottleTimeout=null},100)},this.containerEl.addEventListener("scroll",this.scrollListener),this.registerCleanup(()=>{this.scrollListener&&this.containerEl.removeEventListener("scroll",this.scrollListener),this.scrollThrottleTimeout!==null&&window.clearTimeout(this.scrollThrottleTimeout)}))}setupResizeObserver(){if(this.resizeObserver)return;let i=()=>{let e=D(this.config,this.pluginSettings),s=e.cardSize;this.containerEl.style.setProperty("--card-min-width",`${s}px`),this.containerEl.style.setProperty("--dynamic-views-image-aspect-ratio",String(e.imageAspectRatio))};this.resizeObserver=new ResizeObserver(i),this.resizeObserver.observe(this.containerEl),i()}updateGridLayout(i){this.containerEl.style.setProperty("--card-min-width",`${i.cardSize}px`),this.containerEl.style.setProperty("--dynamic-views-image-aspect-ratio",String(i.imageAspectRatio))}cleanup(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.windowResizeHandler&&(window.removeEventListener("resize",this.windowResizeHandler),this.windowResizeHandler=null),this.scrollListener&&(this.containerEl.removeEventListener("scroll",this.scrollListener),this.scrollListener=null),this.scrollThrottleTimeout!==null&&(window.clearTimeout(this.scrollThrottleTimeout),this.scrollThrottleTimeout=null)}};var ce=class{constructor(i,e,s,t,o,n,r,c){this.containerEl=i;this.plugin=e;this.config=s;this.controller=t;this.data=o;this.selectedFiles=n;this.onSelectionCleared=r;this.registerCleanup=c;this.mutationObserver=null;this.backupInterval=null;this.currentBaseIdentifier=null}setup(i){let e=()=>{this.mutationObserver||(this.mutationObserver=new MutationObserver(c=>{if(this.selectedFiles.size!==0){for(let l of c)if(l.type==="childList"&&l.removedNodes.length>0){let p=!1;for(let d of this.selectedFiles)if(this.containerEl.querySelector(`[data-path="${d}"]`)){p=!0;break}let u=this.containerEl.querySelectorAll(".card[data-path]");if(!p||u.length===0){this.selectedFiles.clear(),this.onSelectionCleared();break}}}}),this.containerEl&&this.mutationObserver.observe(this.containerEl,{childList:!0,subtree:!0}))},s=()=>{this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null,this.selectedFiles.size>0&&this.selectedFiles.clear(),this.onSelectionCleared())},t=()=>{var c,l,p,u;try{if((c=this.config)!=null&&c.getName)return this.config.getName();if((l=this.config)!=null&&l.name)return String(this.config.name);if(this.controller){if((p=this.controller)!=null&&p.getBaseName)return this.controller.getBaseName();if((u=this.controller)!=null&&u.baseName)return String(this.controller.baseName)}if(this.data&&this.data.baseName)return String(this.data.baseName)}catch(d){}return null},o=()=>{if(this.selectedFiles.size===0){this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null);return}let c=t();if(this.currentBaseIdentifier!==null&&c!==null&&this.currentBaseIdentifier!==c){this.selectedFiles.clear(),this.onSelectionCleared(),s(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null);return}this.containerEl.querySelectorAll(".card[data-path]").length===0&&(this.selectedFiles.clear(),this.onSelectionCleared())},n=i.bind(this),r=(c,l)=>{n(c,l),this.selectedFiles.size>0?(this.currentBaseIdentifier===null&&(this.currentBaseIdentifier=t()),e(),this.backupInterval===null&&(this.backupInterval=this.plugin.registerInterval(window.setInterval(o,500)))):(this.currentBaseIdentifier=null,s(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null))};return this.registerCleanup(()=>{s(),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null)}),r}cleanup(){this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.backupInterval!==null&&(window.clearInterval(this.backupInterval),this.backupInterval=null)}};var ve="bases-cms",pe=class extends U.BasesView{constructor(e,s,t){super(e);this.type=ve;this.selectedFiles=new Set;this.snippets={};this.images={};this.hasImageAvailable={};this.updateLayoutRef={current:null};this.propertyObservers=[];this.bulkToolbar=null;this.isRefreshingWithSelection=!1;this.containerEl=s,this.plugin=t,this.cardRenderer=new J(this.app,this.plugin,this.propertyObservers,this.updateLayoutRef,void 0,e),this.containerEl.addClass("bases-cms"),this.containerEl.addClass("bases-cms-container"),this.propertyToggleHandler=new re(this.app,this.config,this.plugin.settings,()=>this.onDataUpdated()),this.scrollLayoutManager=new le(this.containerEl,this.app,this.config,this.plugin.settings,()=>this.onDataUpdated(),n=>this.register(n)),this.viewSwitchListener=new ce(this.containerEl,this.plugin,this.config,this.controller,this.data,this.selectedFiles,()=>this.updateSelectionUI(),n=>this.register(n)),je(this.app,this.containerEl,this.config,this.plugin.settings,n=>this.register(n));let o=this.handleSelectionChange.bind(this);this.handleSelectionChange=this.viewSwitchListener.setup(o)}onDataUpdated(){let e=this.app.workspace.activeLeaf,s=e==null?void 0:e.view;if(s&&this.selectedFiles.size>0&&s!==this){if(!(this.containerEl&&this.containerEl.isConnected&&this.containerEl.offsetParent!==null)){this.selectedFiles.clear(),this.updateSelectionUI();return}let n=s.containerEl;if(!n||!n.contains(this.containerEl)){this.selectedFiles.clear(),this.updateSelectionUI();return}}if(!(this.containerEl&&this.containerEl.isConnected&&this.containerEl.offsetParent!==null)&&this.selectedFiles.size>0){this.selectedFiles.clear(),this.updateSelectionUI();return}(async()=>{var E;let o=this.data.groupedData,n=this.data.data;this.cardRenderer.basesConfig=this.config;let r=D(this.config,this.plugin.settings);this.scrollLayoutManager.updateGridLayout(r);let c=this.containerEl.scrollTop,l=this.getSortMethod(),p=o.map(v=>({group:v,entries:[...v.entries]})),u=[],d=this.scrollLayoutManager.getDisplayedCount();for(let v of p){if(d<=0)break;let m=Math.min(v.entries.length,d);u.push(...v.entries.slice(0,m)),d-=m}if(r.imageFormat!=="none"){let v=n.filter(f=>!(f.file.path in this.images)).map(f=>{let T=this.app.vault.getAbstractFileByPath(f.file.path);if(!(T instanceof U.TFile))return null;let C=xe(f,r.imageProperty);return{path:f.file.path,file:T,imagePropertyValues:C}}).filter(f=>f!==null),m=v.filter(f=>u.some(T=>T.file.path===f.path)),w=v.filter(f=>!u.some(T=>T.file.path===f.path));if(m.length>0&&await fe(m,r.fallbackToEmbeds,this.app,this.images,this.hasImageAvailable),w.length>0&&fe(w,r.fallbackToEmbeds,this.app,this.images,this.hasImageAvailable),r.fallbackToEmbeds){let f=v.filter(T=>!(T.path in this.images)&&!this.hasImageAvailable[T.path]);f.length>0&&Ne(f,this.app,this.images,this.hasImageAvailable).then(()=>{f.forEach(T=>{var C;if(T.path in this.images){let S=this.containerEl.querySelector(`.card[data-path="${T.path}"]`);if(S){let P=this.images[T.path],b=Array.isArray(P)?P[0]:P;if(b){let A=S.querySelector("img");if(A){if(A.src!==b){A.src=b;let M=A.parentElement;M&&M.classList.contains("image-embed")&&M.style.setProperty("--cover-image-url",`url("${b}")`)}}else{let M=S.querySelector(".card-cover-placeholder, .card-thumbnail-placeholder");if(M){let Se=M.querySelector(".card-status-badge"),Ke=M.classList.contains("card-cover-placeholder")?"card-cover":"card-thumbnail",he=(C=M.parentElement)==null?void 0:C.createDiv(Ke);if(he){let Ee=he.createDiv("image-embed");A=Ee.createEl("img",{attr:{src:b,alt:"",decoding:"async"}}),Ee.style.setProperty("--cover-image-url",`url("${b}")`),Se&&he.appendChild(Se),M.remove()}}}}}}})})}}if(r.showTextPreview){let v=u.filter(m=>!(m.file.path in this.snippets)).map(m=>{let w=this.app.vault.getAbstractFileByPath(m.file.path);if(!(w instanceof U.TFile))return null;let f=L(m,r.descriptionProperty);return{path:m.file.path,file:w,descriptionData:f==null?void 0:f.data}}).filter(m=>m!==null);Re(v,r.fallbackToContent,!1,this.app,this.snippets).then(()=>{v.forEach(m=>{if(m.path in this.snippets&&this.snippets[m.path]){let w=this.containerEl.querySelector(`[data-path="${m.path}"]`);if(w){let f=w.__textPreviewEl;f&&(!f.textContent||f.textContent.trim().length===0)&&f.setText(this.snippets[m.path])}}})})}let h=null;if(this.isRefreshingWithSelection&&this.bulkToolbar){let v=this.containerEl.querySelector(".bases-cms-bulk-toolbar");v instanceof HTMLElement&&(h=v,h.remove())}this.containerEl.empty(),this.propertyObservers.forEach(v=>v.disconnect()),this.propertyObservers=[];let g=this.containerEl.createDiv("bases-cms-grid"),y=0,k=[];for(let v of p){if(y>=this.scrollLayoutManager.getDisplayedCount())break;let m=Math.min(v.entries.length,this.scrollLayoutManager.getDisplayedCount()-y);if(m===0)continue;let w=v.entries.slice(0,m),f=g.createDiv("bases-cms-group");if(v.group.hasKey()){let S=f.createDiv("bases-cms-group-heading").createDiv("bases-cms-group-value"),P=((E=v.group.key)==null?void 0:E.toString())||"";S.setText(P)}let T=Fe(w,r,l,!1,this.snippets,this.images,this.hasImageAvailable);for(let C=0;C<T.length;C++){let S=T[C],P=w[C],b=this.renderCard(f,S,P,y+C,r);b&&k.push(b)}y+=m}k.length>0&&requestAnimationFrame(()=>{for(let{img:v,src:m}of k)v.src=m}),c>0&&(this.containerEl.scrollTop=c),this.scrollLayoutManager.setupInfiniteScroll(n.length),this.scrollLayoutManager.setupResizeObserver(),h&&this.bulkToolbar&&(this.containerEl.appendChild(h),this.bulkToolbar.toolbarEl=h),this.isRefreshingWithSelection?(this.containerEl.querySelectorAll(".card").forEach(m=>{let w=m.getAttribute("data-path"),f=m.querySelector('input[type="checkbox"].selection-checkbox');if(w){let T=this.selectedFiles.has(w);T?m.addClass("selected"):m.removeClass("selected"),f&&(f.checked=T)}}),h&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size))):this.updateSelectionUI(),this.scrollLayoutManager.setIsLoading(!1)})()}renderCard(e,s,t,o,n){let r=this.selectedFiles.has(s.path);return this.cardRenderer.renderCard(e,s,t,n,this,r,(c,l)=>{this.handleSelectionChange(c,l)},(c,l,p)=>{this.handlePropertyToggle(c,l,p)})}getSortMethod(){let e=this.config.getSort();if(e&&e.length>0){let s=e[0],t=s.property,o=s.direction.toLowerCase();if(t.includes("ctime"))return`ctime-${o}`;if(t.includes("mtime"))return`mtime-${o}`}return"mtime-desc"}handleSelectionChange(e,s){if(s?this.selectedFiles.add(e):this.selectedFiles.delete(e),this.updateSelectionUI(),this.selectedFiles.size===0&&this.bulkToolbar){this.bulkToolbar.hide();let t=this.containerEl.querySelector(".bases-cms-bulk-toolbar");t instanceof HTMLElement&&(t.removeClass("bases-cms-bulk-toolbar-visible"),t.addClass("bases-cms-bulk-toolbar-hidden"))}}async handlePropertyToggle(e,s,t){await this.propertyToggleHandler.handlePropertyToggle(e,s,t)}selectAll(){this.containerEl.querySelectorAll(".bases-cms-card").forEach(s=>{let t=s.getAttribute("data-path");t&&this.selectedFiles.add(t)}),this.updateSelectionUI()}deselectAll(){this.selectedFiles.clear(),this.updateSelectionUI()}refreshToolbar(){if(this.bulkToolbar){let e=this.selectedFiles.size;this.bulkToolbar.recreate(),e>0&&this.bulkToolbar.updateCount(e)}}updateSelectionUI(){if(this.containerEl.querySelectorAll(".card").forEach(s=>{let t=s.getAttribute("data-path"),o=s.querySelector('input[type="checkbox"].selection-checkbox');if(t){let n=this.selectedFiles.has(t);n?s.addClass("selected"):s.removeClass("selected"),o&&(o.checked=n)}}),this.selectedFiles.size>0){if(document.querySelectorAll(".bases-cms-bulk-toolbar").forEach(t=>{let o=t.__bulkToolbarInstance;(!o||o!==this.bulkToolbar)&&t.remove()}),this.bulkToolbar){let t=D(this.config,this.plugin.settings);this.bulkToolbar.updateSettings(t)}else{let t=D(this.config,this.plugin.settings);this.bulkToolbar=new oe(this.app,this.plugin,this.containerEl,()=>Array.from(this.selectedFiles),()=>{this.selectedFiles.clear(),this.updateSelectionUI()},()=>{let o=Array.from(this.selectedFiles);this.isRefreshingWithSelection=!0,this.bulkToolbar&&o.length>0&&this.bulkToolbar.show(),this.onDataUpdated(),window.setTimeout(()=>{o.forEach(n=>{this.app.vault.getAbstractFileByPath(n)&&this.selectedFiles.add(n)}),this.isRefreshingWithSelection=!1,this.updateSelectionUI(),this.selectedFiles.size>0&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size)),window.setTimeout(()=>{this.selectedFiles.size>0&&this.bulkToolbar&&(this.bulkToolbar.show(),this.bulkToolbar.updateCount(this.selectedFiles.size))},100)},250)},()=>{this.selectAll()},t)}this.bulkToolbar.updateCount(this.selectedFiles.size),this.bulkToolbar.show()}else if(this.bulkToolbar&&!this.isRefreshingWithSelection){this.bulkToolbar.hide();let s=this.containerEl.querySelector(".bases-cms-bulk-toolbar");s instanceof HTMLElement&&(s.removeClass("bases-cms-bulk-toolbar-visible"),s.addClass("bases-cms-bulk-toolbar-hidden"))}}onClose(){this.scrollLayoutManager.cleanup(),this.viewSwitchListener.cleanup(),this.propertyObservers.forEach(t=>t.disconnect()),this.propertyObservers=[],this.bulkToolbar&&this.bulkToolbar.destroy(),this.selectedFiles.clear(),document.querySelectorAll(".bases-cms-bulk-toolbar").forEach(t=>t.remove());let s=this.plugin;s&&typeof s.removeView=="function"&&s.removeView(this)}async onNew(){let e=D(this.config,this.plugin.settings);if(e.customizeNewButton&&e.newNoteLocation&&e.newNoteLocation.trim()!=="")try{let s=e.newNoteLocation.trim().replace(/^\/+|\/+$/g,""),t=this.app.vault.getAbstractFileByPath(s);if((!t||!("children"in t))&&(await this.app.vault.createFolder(s),t=this.app.vault.getAbstractFileByPath(s)),t&&"children"in t){let o=await this.app.vault.create(`${s}/Untitled.md`,"");return await this.app.workspace.openLinkText(o.path,"",!1),!0}}catch(s){console.error("[CMS View] Error creating new note:",s)}return!1}};function we(a,i=5){try{let e=a;if(typeof e.registerBasesView=="function")e.registerBasesView(ve,{name:"CMS",icon:a.settings.useHomeIcon?"lucide-home":"lucide-blocks",factory:(s,t)=>{let o=new pe(s,t,a),n=a;return n.activeViews&&n.activeViews.add(o),o},options:St()});else if(i>0){let s=a,t=s.registrationTimeout;t!=null&&window.clearTimeout(t),s.registrationTimeout=window.setTimeout(()=>{s.registrationTimeout=null,we(a,i-1)},200)}else console.warn("Bases CMS: registerBasesView not available. Is Bases plugin installed?")}catch(e){console.error("Bases CMS: Error registering view:",e)}}function St(){let{getCMSViewOptions:a}=(z(),Ce(Ae));return a}var de=class extends Ge.Plugin{constructor(){super(...arguments);this.activeViews=new Set;this.registrationTimeout=null}async onload(){await this.loadSettings(),this.addSettingTab(new Q(this.app,this)),we(this)}onunload(){this.registrationTimeout!==null&&(window.clearTimeout(this.registrationTimeout),this.registrationTimeout=null),this.activeViews.clear()}async loadSettings(){this.settings=Object.assign({},Pe,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}refreshAllToolbars(){let e=[];this.activeViews.forEach(s=>{let t=s.containerEl;(!t||!t.parentElement)&&e.push(s)}),e.forEach(s=>this.activeViews.delete(s)),this.activeViews.forEach(s=>{s&&typeof s.refreshToolbar=="function"&&s.refreshToolbar()})}removeView(e){this.activeViews.delete(e)}};
